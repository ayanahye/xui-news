<!DOCTYPE html>
<html>
<head>
  <title>Explainable News Classifier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(120deg, #7b5cff 0%, #3a8dff 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .site-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      background: #fff;
      box-shadow: 0 2px 16px 0 rgba(90, 80, 200, 0.10);
      padding: 32px 0 24px 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .dashboard-container {
      max-width: 950px;
      margin: 32px auto 0 auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 6px 32px 0 rgba(90, 80, 200, 0.13);
      padding: 0 38px 38px 38px;
      padding-top: 15vh;
    }
    .widget-tabs {
      display: flex;
      gap: 0;
      border-bottom: 2.5px solid #e0e6f7;
      margin-bottom: 32px;
      margin-top: 0;
    }
    .widget-tab {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      font-size: 1.22em;
      font-weight: 600;
      padding: 18px 0 14px 0;
      color: #7b5cff;
      cursor: pointer;
      border-bottom: 4px solid transparent;
      transition: color 0.2s, border-bottom 0.2s, background 0.2s;
      background: linear-gradient(90deg, #7b5cff05 0%, #3a8dff05 100%);
    }
    .widget-tab.active {
      color: #fff;
      background: linear-gradient(90deg, #7b5cff 0%, #3a8dff 100%);
      border-bottom: 4px solid #3a8dff;
      border-radius: 12px 12px 0 0;
      box-shadow: 0 2px 8px #7b5cff22;
    }
    .widget-content {
      padding-top: 28px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      margin-bottom: 18px;
    }
    .form-group {
      flex: 1 1 320px;
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-weight: 500;
      color: #4a3fbf;
      margin-bottom: 6px;
    }
    textarea, select {
      border: 1.5px solid #a3a0ff;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 1em;
      background: #f0f3ff;
      transition: border 0.2s;
      resize: vertical;
      color: #3a3c8c;
    }
    textarea:focus, select:focus {
      border-color: #3a5cff;
      outline: none;
      background: #fff;
    }
    #exampleSelect {
      font-size: 1em;
      margin-bottom: 0;
    }
    .actions-row {
      display: flex;
      align-items: center; 
      gap: 18px;
      margin-bottom: 10px;
      margin-top: 10px;
    }
    .actions-row label {
      margin-bottom: 0;
    }
    .dashboard-btn {
      background: linear-gradient(90deg, #7b5cff 0%, #3a8dff 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0 32px;
      font-size: 1.08em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 12px #7b5cff88;
      transition: background 0.2s, transform 0.1s;
      height: 40px; 
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .dashboard-btn:hover {
      background: linear-gradient(90deg, #3a8dff 0%, #7b5cff 100%);
      transform: translateY(-2px) scale(1.03);
    }
    .predicted-category {
      font-size: 1.18em;
      font-weight: 500;
      color: #4a3fbf;
      margin: 26px 0 10px 0;
      letter-spacing: 0.5px;
    }
    #visualization {
      margin-top: 18px;
      background: #f0f3ff;
      border-radius: 10px;
      min-height: 60px;
      padding: 18px 16px;
      box-shadow: 0 1px 8px 0 rgba(90, 80, 200, 0.07);
      overflow-x: auto;
    }
    .widget-maintenance {
      background: linear-gradient(90deg, #7b5cff 0%, #3a8dff 100%);
      border-radius: 14px;
      color: #fff;
      padding: 38px 28px 38px 28px;
      font-size: 1.25em;
      font-weight: 500;
      box-shadow: 0 2px 16px 0 rgba(90, 80, 200, 0.10);
      text-align: center;
      margin-top: 12px;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }

    .param-row {
      margin-bottom: 0;
      margin-top: 0;
      gap: 18px;
    }
    .param-row input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      border: 1.5px solid #a3a0ff;
      border-radius: 8px;
      background: #f0f3ff;
      font-size: 1em;
      color: #3a3c8c;
      margin-top: 2px;
      margin-bottom: 2px;
      transition: border 0.2s;
    }
    .param-row input[type="number"]:focus {
      border-color: #3a5cff;
      background: #fff;
    }

    .feature-eng-section {
    background: #f6f8ff;
    border-radius: 14px;
    padding: 28px 24px 24px 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 12px #7b5cff11;
  }
  .feature-eng-section h2 {
    margin-top: 0;
    color: #4a3fbf;
    font-size: 1.3em;
    margin-bottom: 18px;
  }
  .custom-feature-section {
    margin-top: 18px;
    margin-bottom: 18px;
  }
  .feature-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 10px 0 18px 0;
  }
  .feature-chip {
    background: #e3e7ff;
    color: #4a3fbf;
    border-radius: 16px;
    padding: 6px 14px 6px 12px;
    font-size: 1em;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .feature-chip .remove-feature {
    background: none;
    border: none;
    color: #c00;
    font-weight: bold;
    font-size: 1.1em;
    cursor: pointer;
    margin-left: 4px;
  }
  .feature-eng-result {
    margin-top: 10px;
    font-size: 1.1em;
    color: #3a3c8c;
  }

  .custom-select { position: relative; display: inline-block; width: 100%; }
  .select-button { width: 100%; padding: 0.7em 1em; border: 1.5px solid #a3a0ff; border-radius: 8px; background: #f0f3ff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .arrow { margin-left: 10px; }
  .select-dropdown { position: absolute; top: 110%; left: 0; width: 100%; border: 1.5px solid #a3a0ff; border-radius: 8px; background: #fff; box-shadow: 0 10px 25px rgba(90,80,200,0.12); z-index: 2000; padding: 10px; max-height: 350px; overflow-y: auto; }
  .select-dropdown.hidden { display: none; }
  #featureListPage { list-style: none; padding: 0; margin: 0 0 8px 0; }
  #featureListPage li { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f0f3ff; }
  .remove-feature-btn { background: none; border: none; color: #c00; font-weight: bold; font-size: 1.1em; cursor: pointer; }
  .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 12px; margin-bottom: 8px; }
  .pagination-controls button { background: #e3e7ff; border: none; border-radius: 4px; padding: 2px 10px; cursor: pointer; }

  .hidden {
    display: none !important;
  }


  .tutorial-btn {
    position: absolute;
    right: 32px;
    top: 50%;
    transform: translateY(-50%);
    background: #4a3fbf;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 6px 18px;
    font-size: 1em;
    font-weight: 500;
    cursor: pointer;
    box-shadow: 0 1px 6px #7b5cff33;
    transition: background 0.2s;
    height: 38px;
    line-height: 1;
  }

  .tutorial-btn:hover {
   background: #352d8c;
  }

  .tutorial-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(40,40,60,0.65);
    z-index: 9998;
    transition: opacity 0.2s;
  }

  .tutorial-bar {
    background: #fff;
    color: #222;
    border-radius: 10px;
    box-shadow: 0 6px 32px rgba(80,80,120,0.15);
    z-index: 9999;
    min-width: 280px;
    max-width: 350px;
    padding: 18px 24px 14px 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 1.05em;
    position: absolute; 
  }


  .tutorial-bar .tutorial-nav {
    margin-top: 18px;
    display: flex;
    gap: 10px;
  }

  .tutorial-bar button {
    background: #4a3fbf;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 6px 6px;
    font-size: 1em;
    cursor: pointer;
  }

  .tutorial-bar button:disabled {
    background: #bdbaff;
    color: #fff;
    cursor: not-allowed;
  }

  .tutorial-arrow {
    width: 40px;
    height: 40px;
    pointer-events: none;
    position: absolute;
    z-index: 10000;
  }

  .tutorial-arrow svg {
    width: 40px; height: 40px;
    display: block;
  }

  .header-title {
    flex: 1;
    text-align: center;
    font-size: 2.5em;
    font-weight: 700;
    color: #4a3fbf;
    letter-spacing: -1px;
    text-shadow: 0 2px 12px #7b5cff22;
  }

    @media (max-width: 700px) {
      .dashboard-container { padding: 0 4vw 18px 4vw; }
      .form-row { flex-direction: column; gap: 0; }
      .actions-row { flex-direction: column; align-items: stretch; gap: 8px; }
      #visualization { padding: 10px 4px; }
      .dashboard-btn { width: 100%; height: 44px; }
      .widget-tabs { flex-direction: column; }
      .widget-tab { border-radius: 12px 12px 0 0; }
    }
  </style>
</head>
<body>
  <div class="site-header">
    <div class="header-title">Explainable News Classifier</div>
    <button id="tutorialBtn" class="tutorial-btn" onclick="startTutorial()">Tutorial</button>
  </div>
  
  <div id="tutorialOverlay" class="tutorial-overlay hidden"></div>
  <div id="tutorialBar" class="tutorial-bar hidden">
    <div id="tutorialArrow" class="tutorial-arrow"></div>
    <div id="tutorialText"></div>
    <div class="tutorial-nav">
      <button onclick="prevTutorialStep()" id="tutorialPrevBtn">&larr; Previous</button>
      <button onclick="nextTutorialStep()" id="tutorialNextBtn">Next &rarr;</button>
      <button onclick="endTutorial()" id="tutorialEndBtn">End Tutorial</button>
    </div>
  </div>

  <div class="dashboard-container">
    <div class="widget-tabs">
      <button class="widget-tab active" id="tab-predict" onclick="showWidget('predict')">News Category Prediction</button>
      <button class="widget-tab" id="tab-feature" onclick="showWidget('feature')">Feature Engineering</button>
    </div>

    <div class="widget-content" id="widget-predict">
      <div class="form-row">
        <div class="form-group" style="flex:2">
          <label for="exampleSelect">Choose Example</label>
          <select id="exampleSelect">
            <option value="">-- Select a news example --</option>
          </select>
        </div>
        <div class="form-group" style="flex:1">
          <label for="authorsInput">Authors</label>
          <textarea id="authorsInput" rows="1" placeholder="enter authors..."></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="headlineInput">Headline</label>
          <textarea id="headlineInput" rows="2" placeholder="enter headline..."></textarea>
        </div>
        <div class="form-group">
          <label for="shortDescriptionInput">Short Description</label>
          <textarea id="shortDescriptionInput" rows="2" placeholder="enter short description..."></textarea>
        </div>
      </div>
      <div class="form-row param-row">
        <div class="form-group" style="flex:1">
          <label for="minDfInput">Min. Word Occurrences (<code>min_df</code>)</label>
          <input type="number" id="minDfInput" min="1" max="100" value="5" />
        </div>
        <div class="form-group" style="flex:1">
          <label for="numFeaturesInput"># Top Features (<code>top_n</code>)</label>
          <input type="number" id="numFeaturesInput" min="1" max="50" value="15" />
        </div>
        <div class="form-group" style="flex:1">
          <label for="trainDataSize">Dataset Size</label>
          <select id="trainDataSize">
            <option value="500">500</option>
            <option value="1000">1000</option>
            <option value="1500">1500</option>
            <option value="2000">2000</option>
            <option value="all">All</option>
          </select>
        </div>
      </div>
      <div class="actions-row">
        <div class="form-group" style="flex:0.5">
          <label for="methodSelect">Method</label>
          <select id="methodSelect" onchange="toggleShapPlotType()">
            <option value="SHAP">SHAP</option>
            <option value="LIME">LIME</option>
          </select>
        </div>
        <div class="form-group" id="shapPlotTypeContainer" style="flex:0.7">
          <label for="plotTypeSelect">SHAP Plot Type</label>
          <select id="plotTypeSelect">
            <option value="force">Force (local)</option>
            <option value="beeswarm">Beeswarm (global)</option>
            <option value="summary">Summary (global)</option>
            <option value="waterfall">Waterfall (local)</option>
          </select>
        </div>
        <button class="dashboard-btn" onclick="getExplanation()">Explain</button>
      </div>
      <div class="predicted-category">
        Predicted Category: <span id="predClass"></span>
      </div>
      <div id="visualization"></div>
    </div>

    <div class="widget-content" id="widget-feature" style="display:none;">
      <div class="feature-eng-section">
        <h2>Feature Engineering Options</h2>
        <div class="form-row">
          <div class="form-group" style="flex:1">
            <label>
              <input type="checkbox" id="removeStopwords">
              Remove common (stop) words
            </label>
          </div>
          <div class="form-group" style="flex:1">
            <label for="ngramRange">N-gram Range</label>
            <select id="ngramRange">
              <option value="1,1">Unigrams (1,1)</option>
              <option value="1,2">Unigrams+Bigrams (1,2)</option>
              <option value="2,2">Bigrams (2,2)</option>
              <option value="1,3">1 to 3-grams (1,3)</option>
            </select>
          </div>
          <div class="form-group" style="flex:1">
            <label for="featureSelectionMethod">Feature Selection</label>
            <select id="featureSelectionMethod">
              <option value="none">Document Frequency</option>
              <option value="chi2">Information Gain</option>
              <option value="mutual_info">Gini Index</option>
              <option value="variance">Chi-Square</option>
              <option value="variance">Best Term</option>
              <option value="variance">Ambiguity Measure</option>
              <option value="variance">Distinguishing Feature Selector</option>
            </select>
          </div>
        </div>
        <div class="custom-feature-section">
          <div class="form-group">
            <label>Custom Feature Removal</label>
            <div class="custom-select" id="featureDropdown">
              <button type="button" class="select-button" onclick="toggleFeatureDropdown()">
                Remove Features <span class="arrow">&#9660;</span>
              </button>
              <div class="select-dropdown hidden" id="featureListDropdown">
                <ul id="featureListPage"></ul>
                <div class="pagination-controls">
                  <button onclick="prevFeaturePage()" id="prevFeatureBtn">&lt;</button>
                  <span id="featurePageInfo"></span>
                  <button onclick="nextFeaturePage()" id="nextFeatureBtn">&gt;</button>
                </div>
              </div>
              <p>Note: Features will refresh after changing N-gram Range. This may take a few seconds.</p>
            </div>
          </div>
          <button class="dashboard-btn" onclick="retrainModel()">Retrain Model</button>
        </div>
        <div id="featureEngResult" class="feature-eng-result"></div>
      </div>
    </div>
  </div>
  <script>

    let allFeatures = [];        
    let removedFeatures = new Set(); 
    let featurePage = 0;
    const featuresPerPage = 25;
    // slay
    const tutorialSteps = [
    {
      selector: "#exampleSelect",
      text: "👋 Welcome to the Tutorial!<br><br>This is the <b>Example News Article</b> selector. Click to pick a real news headline and description to try out the model.",
      arrow: "down"
    },
    {
      selector: "#authorsInput",
      text: "Here you can enter the <b>authors</b> of the news article. This can help the model if certain authors write about specific topics.",
      arrow: "down"
    },
    {
      selector: "#headlineInput",
      text: "Type or paste the <b>headline</b> of a news article here. The headline is important for understanding what the article is about.",
      arrow: "down"
    },
    {
      selector: "#shortDescriptionInput",
      text: "This is the <b>short description</b> of the article. It gives more detail and helps the model make a better prediction.",
      arrow: "down"
    },
    {
      selector: "#minDfInput",
      text: "<b>Min. Word Occurrences</b> (<code>min_df</code>)<br><br>This controls how rare a word must be to be included as a feature (something model considers to make a prediction). Higher values mean only common words are used. Try changing it to see how it affects the model!",
      arrow: "up"
    },
    {
      selector: "#numFeaturesInput",
      text: "<b># Top Features</b> (<code>top_n</code>)<br><br>This sets how many of the most important words or phrases are shown in the explanation. Try different numbers to see more or fewer features.",
      arrow: "up"
    },
    {
      selector: "#trainDataSize",
      text: "<b>Dataset Size</b><br><br>This lets you choose how much data the model uses for training. More data can help the model learn, but might take longer to retrain.",
      arrow: "up"
    },
    {
      selector: "#methodSelect",
      text: "<b>Explanation Method</b><br><br>Choose between <b>SHAP</b> and <b>LIME</b> for different styles of model explanation. SHAP is great for seeing how each word affects the prediction and comes with various different visualizations. LIME is more like a local 'what-if' explainer.",
      arrow: "up"
    },
    {
      selector: "#plotTypeSelect",
      text: "<b>SHAP Plot Type</b><br><br>If you chose SHAP, you can pick different ways to visualize the explanation. Try each one to see what you like best!",
      arrow: "up"
    },
    {
      selector: ".dashboard-btn", 
      text: "When you're ready, click <b>Explain</b> to see the model's prediction and explanation for your article!",
      arrow: "up"
    }
  ];

  let tutorialStep = 0;

  function startTutorial() {
  document.getElementById("tutorialOverlay").classList.remove("hidden");
  document.getElementById("tutorialBar").classList.remove("hidden");
  tutorialStep = 0;
  showTutorialStep();
  }

  function endTutorial() {
  document.getElementById("tutorialOverlay").classList.add("hidden");
  document.getElementById("tutorialBar").classList.add("hidden");
  removeArrow();
  }

  function showTutorialStep() {
    const step = tutorialSteps[tutorialStep];
    const elem = document.querySelector(step.selector);
    const tutorialBar = document.getElementById("tutorialBar");
    const tutorialArrow = document.getElementById("tutorialArrow");
    const tutorialText = document.getElementById("tutorialText");

    tutorialText.innerHTML = step.text;

    if (!elem) {
      tutorialBar.style.position = "fixed";
      tutorialBar.style.left = "50%";
      tutorialBar.style.top = "";
      tutorialBar.style.bottom = "40px";
      tutorialBar.style.transform = "translateX(-50%)";
      tutorialArrow.style.display = "none";
    } else {
      const rect = elem.getBoundingClientRect();
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

      let barLeft, barTop;
      const spacing = 12; 

      if (step.arrow === "down") {
        barTop = rect.bottom + scrollTop + spacing;
        barLeft = rect.left + scrollLeft + rect.width / 2;
        tutorialBar.style.transform = "translateX(-50%)";
      } else {
        barTop = rect.top + scrollTop - spacing;
        barLeft = rect.left + scrollLeft + rect.width / 2;
        tutorialBar.style.transform = "translateX(-50%) translateY(-100%)";
      }

      tutorialBar.style.position = "absolute";
      tutorialBar.style.left = `${barLeft}px`;
      tutorialBar.style.top = `${barTop}px`;
      tutorialBar.style.bottom = "";

      tutorialArrow.style.display = "block";
      tutorialArrow.style.position = "absolute";

      if (step.arrow === "down") {
        tutorialArrow.innerHTML = `<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <polygon points="20,0 40,40 0,40" style="fill:#fff;stroke:#4a3fbf;stroke-width:2"/>
        </svg>`;
        tutorialArrow.style.top = "-38px"; 
      } else {
        tutorialArrow.innerHTML = `<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <polygon points="0,0 40,0 20,40" style="fill:#fff;stroke:#4a3fbf;stroke-width:2"/>
        </svg>`;
        tutorialArrow.style.top = "100%";
      }

      tutorialArrow.style.left = "50%";
      tutorialArrow.style.transform = "translateX(-50%)";
    }

    document.getElementById("tutorialPrevBtn").disabled = (tutorialStep === 0);
    document.getElementById("tutorialNextBtn").disabled = (tutorialStep === tutorialSteps.length - 1);
  }


  function nextTutorialStep() {
    if (tutorialStep < tutorialSteps.length - 1) {
      tutorialStep++;
      showTutorialStep();
    }
  }

  function prevTutorialStep() {
    if (tutorialStep > 0) {
      tutorialStep--;
      showTutorialStep();
    }
  }

  function removeArrow() {
    const arrow = document.getElementById("tutorialArrow");
    arrow.innerHTML = "";
    arrow.style.display = "none";
  }

  function pointArrowTo(selector, direction) {
    const arrow = document.getElementById("tutorialArrow");
    const elem = document.querySelector(selector);
    if (!elem) {
      arrow.style.display = "none";
      return;
    }
    const rect = elem.getBoundingClientRect();
    arrow.style.display = "block";
    let left, top;
    if (direction === "down") {
      left = rect.left + rect.width / 2 - 20;
      top = rect.bottom + window.scrollY + 6;
      arrow.innerHTML = `<svg><polygon points="20,0 40,40 0,40" style="fill:#fff;stroke:#4a3fbf;stroke-width:2"/></svg>`;
    } else {
      left = rect.left + rect.width / 2 - 20;
      top = rect.top + window.scrollY - 46;
      arrow.innerHTML = `<svg><polygon points="0,0 40,0 20,40" style="fill:#fff;stroke:#4a3fbf;stroke-width:2"/></svg>`;
    }
    arrow.style.left = left + "px";
    arrow.style.top = top + "px";
  }

    function showWidget(widget) {
      document.getElementById('widget-predict').style.display = widget === 'predict' ? '' : 'none';
      document.getElementById('widget-feature').style.display = widget === 'feature' ? '' : 'none';
      document.getElementById('tab-predict').classList.toggle('active', widget === 'predict');
      document.getElementById('tab-feature').classList.toggle('active', widget === 'feature');
    }

    async function loadSampledArticles() {
      const response = await fetch('/sampled_articles');
      const articles = await response.json();
      const select = document.getElementById('exampleSelect');
      articles.forEach((article, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.text = `[${article.category}] ${article.headline.slice(0, 60)}...`;
        option.dataset.headline = article.headline;
        option.dataset.shortDescription = article.short_description;
        option.dataset.authors = article.authors;
        select.appendChild(option);
      });
      select.onchange = function() {
        const selected = select.options[select.selectedIndex];
        if (selected.value !== "") {
          document.getElementById('headlineInput').value = selected.dataset.headline;
          document.getElementById('shortDescriptionInput').value = selected.dataset.shortDescription;
          document.getElementById('authorsInput').value = selected.dataset.authors;
        } else {
          document.getElementById('headlineInput').value = "";
          document.getElementById('shortDescriptionInput').value = "";
          document.getElementById('authorsInput').value = "";
        }
      };
    }
    window.onload = loadSampledArticles;

    function toggleShapPlotType() {
      const method = document.getElementById("methodSelect").value;
      document.getElementById("shapPlotTypeContainer").style.display =
        (method === "SHAP") ? "block" : "none";
    }
    toggleShapPlotType();

    async function fetchPredictedClass(combinedText) {
      const featureEngParams = getFeatureEngParams();
      const trainDataSize = document.getElementById("trainDataSize").value;
      const payload = {
        combined_text: combinedText,
        train_data_size: trainDataSize,
        ...featureEngParams,
        features_to_remove: Array.from(removedFeatures)
      };
      const response = await fetch('/predict', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await response.json();
      return data.predicted_class || "";
    }

    function getFeatureEngParams() {
      const removeStopwords = document.getElementById("removeStopwords").checked;
      const ngramRange = document.getElementById("ngramRange").value.split(',').map(Number);
      return {
        remove_stopwords: removeStopwords,
        ngram_range: ngramRange
      };
    }

    function toggleFeatureDropdown() {
      const dropdown = document.getElementById("featureListDropdown");
      dropdown.classList.toggle("hidden");
      if (allFeatures.length === 0) fetchFeatureList();
    }

    async function fetchFeatureList() {
      const resp = await fetch('/features');
      allFeatures = await resp.json();
      featurePage = 0;
      renderFeatureListPage();
    }

    function renderFeatureListPage() {
      const start = featurePage * featuresPerPage;
      const end = start + featuresPerPage;
      const pageFeatures = allFeatures.slice(start, end);

      const ul = document.getElementById("featureListPage");
      ul.innerHTML = "";
      pageFeatures.forEach(f => {
        const li = document.createElement("li");
        li.textContent = f;
        if (removedFeatures.has(f)) {
          li.style.opacity = 0.4;
        }
        const btn = document.createElement("button");
        btn.innerHTML = "&times;";
        btn.className = "remove-feature-btn";
        btn.disabled = removedFeatures.has(f);
        btn.onclick = () => {
          removedFeatures.add(f);
          li.style.opacity = 0.4;
          btn.disabled = true;
        };
        li.appendChild(btn);
        ul.appendChild(li);
      });

      document.getElementById("featurePageInfo").textContent =
        `Page ${featurePage + 1} of ${Math.ceil(allFeatures.length / featuresPerPage)}`;
      document.getElementById("prevFeatureBtn").disabled = featurePage === 0;
      document.getElementById("nextFeatureBtn").disabled = end >= allFeatures.length;
    }

    function prevFeaturePage() {
      if (featurePage > 0) {
        featurePage--;
        renderFeatureListPage();
      }
    }
    function nextFeaturePage() {
      if ((featurePage + 1) * featuresPerPage < allFeatures.length) {
        featurePage++;
        renderFeatureListPage();
      }
    }

    async function retrainModel() {
      document.getElementById("featureListDropdown")?.classList.add("hidden");
      showWidget('predict');
      document.getElementById("featureEngResult").innerText = "Model retrained with new settings!";
      setTimeout(async () => {
        await getExplanation();
        allFeatures = [];
        await fetchFeatureList();
        setTimeout(() => {
          document.getElementById("featureEngResult").innerText = "";
        }, 2000);
      }, 200);
    }

    async function getExplanation() {
      const headline = document.getElementById("headlineInput").value;
      const shortDescription = document.getElementById("shortDescriptionInput").value;
      const authors = document.getElementById("authorsInput").value;
      const combinedText = headline + " " + shortDescription + " " + authors;
      const method = document.getElementById("methodSelect").value;
      const plotType = document.getElementById("plotTypeSelect").value;
      const minDf = parseInt(document.getElementById("minDfInput").value, 10);
      const topN = parseInt(document.getElementById("numFeaturesInput").value, 10);
      const trainDataSize = document.getElementById("trainDataSize").value;
      const featureEngParams = getFeatureEngParams();

      document.getElementById("visualization").innerHTML = "<span style='color:#4a3fbf'>Loading...</span>";
      const payload = {
        combined_text: combinedText,
        method: method,
        plot_type: plotType,
        min_df: minDf,
        top_n: topN,
        train_data_size: trainDataSize,
        ...featureEngParams,
        features_to_remove: Array.from(removedFeatures)
      };

      const response = await fetch('/explain', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      let data;
      if (method === "SHAP" && (plotType === "beeswarm" || plotType === "summary" || plotType === "waterfall")) {
        data = await response.text();
      } else {
        data = await response.json();
      }

      if (method === "LIME") {
        document.getElementById("visualization").innerHTML = data.visualization;
        const scriptTags = document.getElementById("visualization").getElementsByTagName('script');
        for (let i = 0; i < scriptTags.length; i++) {
          eval(scriptTags[i].innerText);
        }
        document.getElementById("predClass").innerText = data.predicted_class || "";
      } else if (method === "SHAP" && plotType === "force") {
        document.getElementById("visualization").innerHTML =
          `<iframe id="shapFrame" width="100%" height="350" frameborder="0"></iframe>`;
        document.getElementById("shapFrame").srcdoc = data.visualization;
        const predClass = await fetchPredictedClass(combinedText);
        document.getElementById("predClass").innerText = predClass;
      } else if (method === "SHAP" && plotType === "waterfall") {
        document.getElementById("visualization").innerHTML =
          `<iframe id="plotlyFrame" width="100%" height="600" frameborder="0"></iframe>`;
        document.getElementById("plotlyFrame").srcdoc = data;
        const predClass = await fetchPredictedClass(combinedText);
        document.getElementById("predClass").innerText = predClass;
      } else if (method === "SHAP" && (plotType === "beeswarm" || plotType === "summary")) {
        document.getElementById("visualization").innerHTML =
          `<iframe id="plotlyFrame" width="100%" height="600" frameborder="0"></iframe>`;
        document.getElementById("plotlyFrame").srcdoc = data;
        document.getElementById("predClass").innerText = ""; 
      } else {
        document.getElementById("visualization").innerHTML = "<em>No visualization available.</em>";
        document.getElementById("predClass").innerText = "";
      }
    }

    document.getElementById("ngramRange").addEventListener("change", async function() {
      await getExplanation(); 
      allFeatures = [];
      await fetchFeatureList();
    });

  </script>
</body>
</html>
