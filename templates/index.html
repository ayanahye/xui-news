<!DOCTYPE html>
<html>
<head>
  <title>Explainable News Classifier</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    textarea { width: 100%; }
    #visualization { margin-top: 30px; }
    #exampleSelect { width: 100%; padding: 6px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>Explainable News Classifier</h2>

  <label for="exampleSelect"><b>Choose Example:</b></label>
  <select id="exampleSelect">
    <option value="">-- Select a news example --</option>
  </select>
  <br><br>

  <label>Headline:</label>
  <textarea id="headlineInput" rows="2" placeholder="Enter headline..."></textarea><br><br>

  <label>Short Description:</label>
  <textarea id="shortDescriptionInput" rows="2" placeholder="Enter short description..."></textarea><br><br>

  <label>Authors:</label>
  <textarea id="authorsInput" rows="1" placeholder="Enter authors..."></textarea><br><br>

  <label>Method:</label>
  <select id="methodSelect" onchange="toggleShapPlotType()">
    <option value="SHAP">SHAP</option>
    <option value="LIME">LIME</option>
  </select>
  <span id="shapPlotTypeContainer">
    <label>SHAP Plot Type:</label>
    <select id="plotTypeSelect">
      <option value="force">Force (local)</option>
      <option value="beeswarm">Beeswarm (global)</option>
      <option value="summary">Summary (global)</option>
      <option value="waterfall">Waterfall (local)</option>
    </select>
  </span>
  <button onclick="getExplanation()">Explain</button>

  <h3>Predicted Category: <span id="predClass"></span></h3>
  <div id="visualization"></div>

  <script>
    async function loadSampledArticles() {
      const response = await fetch('/sampled_articles');
      const articles = await response.json();
      const select = document.getElementById('exampleSelect');
      articles.forEach((article, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.text = `[${article.category}] ${article.headline.slice(0, 60)}...`;
        option.dataset.headline = article.headline;
        option.dataset.shortDescription = article.short_description;
        option.dataset.authors = article.authors;
        select.appendChild(option);
      });

      select.onchange = function() {
        const selected = select.options[select.selectedIndex];
        if (selected.value !== "") {
          document.getElementById('headlineInput').value = selected.dataset.headline;
          document.getElementById('shortDescriptionInput').value = selected.dataset.shortDescription;
          document.getElementById('authorsInput').value = selected.dataset.authors;
        } else {
          document.getElementById('headlineInput').value = "";
          document.getElementById('shortDescriptionInput').value = "";
          document.getElementById('authorsInput').value = "";
        }
      };
    }
    window.onload = loadSampledArticles;

    function toggleShapPlotType() {
      const method = document.getElementById("methodSelect").value;
      document.getElementById("shapPlotTypeContainer").style.display =
        (method === "SHAP") ? "inline" : "none";
    }
    toggleShapPlotType();

    async function getExplanation() {
      const headline = document.getElementById("headlineInput").value;
      const shortDescription = document.getElementById("shortDescriptionInput").value;
      const authors = document.getElementById("authorsInput").value;
      const combinedText = headline + " " + shortDescription + " " + authors;
      const method = document.getElementById("methodSelect").value;
      const plotType = document.getElementById("plotTypeSelect").value;

      document.getElementById("visualization").innerHTML = "Loading...";

      const payload = {
        combined_text: combinedText,
        method: method,
        plot_type: plotType
      };

      const response = await fetch('/explain', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      let data;
      if (method === "SHAP" && (plotType === "beeswarm" || plotType === "summary" || plotType === "waterfall")) {
        data = await response.text();
      } else {
        data = await response.json();
      }

      if (method === "Influence") {
        document.getElementById("visualization").innerHTML =
          "<ul>" + data.influential_examples.map(ex =>
            `<li><b>${ex.category}</b>: ${ex.headline}</li>`).join("") + "</ul>";
        document.getElementById("predClass").innerText = data.predicted_class || "";
      } else if (method === "LIME") {
        document.getElementById("visualization").innerHTML = data.visualization;
        const scriptTags = document.getElementById("visualization").getElementsByTagName('script');
        for (let i = 0; i < scriptTags.length; i++) {
          eval(scriptTags[i].innerText);
        }
        document.getElementById("predClass").innerText = data.predicted_class || "";
      } else if (method === "SHAP" && plotType === "force") {
        document.getElementById("visualization").innerHTML =
          `<iframe id="shapFrame" width="100%" height="350" frameborder="0"></iframe>`;
        document.getElementById("shapFrame").srcdoc = data.visualization;
        document.getElementById("predClass").innerText = data.predicted_class || "";
      } else if (method === "SHAP" && (plotType === "beeswarm" || plotType === "summary" || plotType === "waterfall")) {
        document.getElementById("visualization").innerHTML =
          `<iframe id="plotlyFrame" width="100%" height="600" frameborder="0"></iframe>`;
        document.getElementById("plotlyFrame").srcdoc = data;
        document.getElementById("predClass").innerText = ""; 
      } else {
        document.getElementById("visualization").innerHTML = "<em>No visualization available.</em>";
        document.getElementById("predClass").innerText = "";
      }
    }
  </script>
</body>
</html>
